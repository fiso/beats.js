<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width">
    <title>BEATS</title>
    <link rel="stylesheet" href="css/base.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="js/beats.js"></script>
</head>

<body>
    <div id="debug">
        <span id="current-beat">0</span>
    </div>
    <div id="timeline">
    </div>

    <div id="animation-container">

        <div id="flasher">
        </div>

        <div id="lyrics-container">
        </div>

        <div id="scene-1" class="scene-container">
        </div>

        <div id="scene-2" class="scene-container">
        </div>

        <div id="scene-3" class="scene-container">
        </div>

        <div id="scene-4" class="scene-container">
        </div>

        <div id="scene-5" class="scene-container">
        </div>

        <div id="scene-6" class="scene-container">
        </div>

        <div id="scene-7" class="scene-container">
        </div>

        <div id="scene-8" class="scene-container">
        </div>
    </div>

    <script>
        var strobeInterval = -1;

        $(document).ready(function() {
            var element = document.getElementById("animation-container");
            element.style["width"] = window.innerWidth + "px";
            element.style["height"] = window.innerHeight + "px";

            window.beats = new Beats("/audio/track.mp3", 0.2);
            //window.beats = new Beats("/audio/track2.mp3", 13.4, 150);

            beats.ready().then(function () {
                setInterval(function() {
                    var element = document.getElementById("timeline");
                    var position = beats.track.currentTime / beats.track.duration;
                    var pct = position * 100;
                    element.setAttribute("style", "width:" + pct + "%");
                }, 100);

                window.beats.addEveryBeatCallback(function(beat) {
                    var beatElement = document.getElementById("current-beat");
                    beatElement.innerHTML = beat;
                    if (beat < 0) {
                        return;
                    }
                    var element = document.getElementById("flasher");
                    element.innerHTML = (beat % 4) + 1;
                    element.style["opacity"] = 1;
                    setTimeout(function() {
                        element.style["opacity"] = 0;
                    }, 100);
                });

                window.beats.addBeatCallback(32, function() {
                    var element = document.getElementById("scene-1");
                    element.style["display"] = "inline-block";
                });

                window.beats.addBeatCallback(64, function() {
                    var element = document.getElementById("scene-2");
                    element.style["display"] = "inline-block";
                });

                window.beats.addBeatCallback(128, function() {
                    var element = document.getElementById("scene-3");
                    element.style["display"] = "inline-block";
                });

                window.beats.addBeatCallback(192, function() {
                    var element = document.getElementById("scene-4");
                    element.style["display"] = "inline-block";
                });

                window.beats.addBeatCallback(256, function() {
                    var element = document.getElementById("scene-5");
                    element.style["display"] = "inline-block";
                });

                var verseLyrics = "#### (Hey¤ ba¤by?)¤ What's# crac¤kin'?¤ Who¤ ya¤ mac¤kin'?¤ What¤%cha¤ do¤in'?¤" +
                                  " Who¤ ya¤ screw¤in'?¤% What¤cha¤ drink¤in?¤ What¤cha¤ think¤in'?" +
                                  "###¤ (Hey¤ ba¤by!)¤ Say¤ my¤ name#% Play¤ your¤ game# Wan¤na¤ do¤ me?" +
                                  "¤% Wan¤na¤ screw¤ me?¤ I'm¤ your¤ pet#% Make¤ me¤ wet" +
                                  "###¤% (Hey,¤ ba¤by?)¤ Don't¤ ya¤ stare# I¤ don't¤% care#% Want¤ some¤ fun?" +
                                  "# Make¤ me¤ cum# Keep¤ it¤ go¤in'¤% Cause% it's¤% snow¤in'" +
                                  "###% (Hey,¤ ba¤by?!)¤ Tie¤ me¤ up#% Pin¤ me¤ down#% Flip¤ me¤ o¤ver¤" +
                                  " Up¤side¤ down#% Make¤ me¤ make¤ that¤ fuck¤in'¤ sound";

                window.beats.addLyricsCallback(318,
                    verseLyrics + verseLyrics + verseLyrics,
                    function(text) {
                        var element = document.getElementById("lyrics-container");
                        element.innerHTML += text;
                });

                window.beats.addBeatCallback(320, function() {
                    var element = document.getElementById("scene-6");
                    element.style["display"] = "inline-block";
                });

                var upsideDown = function() {
                    var element = document.getElementById("animation-container");
                    element.style["transitionDuration"] = window.beats.getTimePerBeat() + "s";
                    element.style["transform"] = "rotate(180deg)";
                    setTimeout(function() {
                        element.style["transform"] = "rotate(0deg)";
                    }, window.beats.getTimePerBeat() * 1000);
                };

                window.beats.addBeatCallback(376, upsideDown);
                window.beats.addBeatCallback(440, upsideDown);

                window.beats.addBeatCallback(448, function() {
                    var element = document.getElementById("scene-7");
                    element.style["display"] = "inline-block";
                });

                window.beats.addBeatCallback(512, function() {
                    var element = document.getElementById("scene-8");
                    element.style["display"] = "inline-block";
                });

                window.beats.addBeatCallback(640, function() {
                    if (strobeInterval === -1) {
                        var element = document.getElementsByTagName("body")[0];
                        var on = true;
                        element.style["backgroundColor"] = "white";
                        strobeInterval = setInterval(function() {
                            on = !on;
                            element.style["backgroundColor"] = on ? "white" : "black";
                        }, window.beats.getTimePerBeat() * 1000 / 10);
                    }
                });

                window.beats.addBeatCallback(704, function() {
                    if (strobeInterval !== -1) {
                        var element = document.getElementsByTagName("body")[0];
                        element.style["backgroundColor"] = "black";
                        clearInterval(strobeInterval);
                        strobeInterval = -1;
                    }
                });

                window.addEventListener("keydown", function(event) {
                    event = event || window.event;
                    // console.log(event.keyCode);
                    switch (event.keyCode) {
                        case 32: // Space
                            //window.beats.track.currentTime = 150; // Temp
                            //window.beats.track.playbackRate = 0.5;
                            if (window.beats.track.paused) {
                                window.beats.track.play();
                            } else {
                                window.beats.track.pause();
                            }
                            break;
                        case 81: // Q
                            window.beats.track.currentTime = window.beats.offset;
                            window.beats.track.play();
                            break;
                        case 87: // W
                            console.log(window.beats.getTimeToNearestBeat());
                            break;
                        case 69: // E
                            console.log(window.beats.getCurrentBeat());
                            break;
                        case 39: // Right
                            window.beats.track.currentTime += 10;
                            break;
                        case 37: // Left
                            window.beats.track.currentTime -= 10;
                            break;
                        case 38: // Up
                            window.beats.track.playbackRate += 0.05;
                            break;
                        case 40: // Down
                        window.beats.track.playbackRate -= 0.05;
                            break;
                        default:
                            break;
                    }
                }, false);
            });
        });
    </script>
</body>

</html>
